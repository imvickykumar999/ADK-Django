# Hosting on Custom Onion URL

Here are the steps to set up your Flask application as a Tor Hidden Service.

-----

## 1\. Install Tor

First, install the Tor service package on your Linux server.

```bash
sudo apt update
sudo apt install tor
```

## 2\. Configure the Hidden Service

Next, you need to edit the Tor configuration file (`torrc`) to define your new Hidden Service.

```bash
sudo nano /etc/tor/torrc
```

Scroll to the end of the file and add the following lines. This tells Tor to create a new service and defines where traffic to that service's unique `.onion` port 80 should be forwarded (proxied) internally.

```ini
# Hidden Service for ADK-Flask on Gunicorn Port 5000
HiddenServiceDir /var/lib/tor/adk_flask_service/
HiddenServicePort 80 127.0.0.1:5000
```

  * **`HiddenServiceDir`**: This directory will be created by Tor and will contain the private key and the file storing your unique `.onion` address.
  * **`HiddenServicePort 80 127.0.0.1:5000`**: This maps external Tor requests on port **80** (the standard web port) to your local Gunicorn process running on **127.0.0.1:5000**.

## 3\. Restart Tor and Retrieve the .onion Address

Save and close the `torrc` file, then restart the Tor service.

```bash
sudo systemctl restart tor
```

The unique `.onion` address is automatically generated and stored in the `hostname` file within the service directory. Retrieve it using the following command:

```bash
sudo cat /var/lib/tor/adk_flask_service/hostname
```

This command will output your permanent Tor address, which will look something like:

`[32_or_56_character_string].onion`

-----

## 4\. Final Steps (No Nginx/Gunicorn Changes Required)

You do **not** need to change your Nginx or Gunicorn service files because:

  * **Nginx is bypassed:** Traffic from Tor goes directly to the Tor daemon, which forwards it internally to Gunicorn. Nginx is no longer needed for this traffic path.
  * **Gunicorn is already configured:** Your Gunicorn process is already listening on `0.0.0.0:5000`, which includes the loopback address (`127.0.0.1`) that Tor is using for its forwarding.

You can now access your application via the `.onion` address (e.g., `http://[your_onion_address].onion`) using the Tor Browser.

## 1\. Local File Transfer (Windows to Server)

Create custom onion URL from https://github.com/imvickykumar999/CustomOnionURL

You used `scp` to transfer your pre-generated Tor private key archive to the server's `/home/repo/` directory:

```bash
scp "C:\Users\surface\Documents\task\vickyme6ywivszfs6c2oekjxgatrl7xykwsc355llydysuj7eexokfyd.onion.zip" root@157.254.189.17:/home/repo/
```

-----

## 2\. Gunicorn Service Setup (Internal Application Host)

You corrected and restarted your Gunicorn service to ensure the Flask application runs reliably using the correct WSGI worker on port **5000** (matching your Nginx configuration).

```bash
# Edit the service file (ensure the content is correct, without Uvicorn worker)
sudo nano /etc/systemd/system/gunicorn.service

# Apply the changes and restart
sudo systemctl daemon-reload
sudo systemctl restart gunicorn.service
```

The correct `ExecStart` line in the file is:

```ini
ExecStart=/home/repo/ADK-Flask/.venv/bin/gunicorn --workers 3 --bind 0.0.0.0:5000 app:app
```

-----

## 3\. Basic Tor Installation and Configuration

You installed the Tor service and configured it to use a Hidden Service that maps to your Gunicorn application.

```bash
# Install the Tor service
sudo apt update
sudo apt install tor

# Edit the Tor configuration file
sudo nano /etc/tor/torrc
```

You added these lines to the `torrc` file:

```ini
# Hidden Service for ADK-Flask on Gunicorn Port 5000
HiddenServiceDir /var/lib/tor/adk_flask_service/
HiddenServicePort 80 127.0.0.1:5000
```

-----

## 4\. Activating the Permanent .onion Address

This is the most crucial step, where you replaced the automatically generated keys with your permanent keys to ensure a stable `.onion` address.

Assuming you are currently in the directory containing the unzipped keys (`/home/repo/vickyme6ywivszfs6c2oekjxgatrl7xykwsc355llydysuj7eexokfyd.onion/`):

```bash
# 1. Stop the Tor service
sudo systemctl stop tor

# 2. Delete the temporary keys generated by Tor
sudo rm /var/lib/tor/adk_flask_service/hostname
sudo rm /var/lib/tor/adk_flask_service/hs_ed25519_public_key
sudo rm /var/lib/tor/adk_flask_service/hs_ed25519_secret_key

# 3. Copy the permanent keys into the Tor service directory
sudo cp hostname /var/lib/tor/adk_flask_service/
sudo cp hs_ed25519_public_key /var/lib/tor/adk_flask_service/
sudo cp hs_ed25519_secret_key /var/lib/tor/adk_flask_service/

# 4. Set the correct ownership and permissions (CRITICAL for Tor security)
sudo chown -R debian-tor:debian-tor /var/lib/tor/adk_flask_service/
sudo chmod 600 /var/lib/tor/adk_flask_service/hs_ed25519_secret_key

# 5. Restart Tor to activate the permanent address
sudo systemctl restart tor

# 6. Verify the permanent address (optional, but good practice)
sudo cat /var/lib/tor/adk_flask_service/hostname
```
